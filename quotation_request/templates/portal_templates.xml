<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="portal_breadcrumbs" inherit_id="portal.portal_breadcrumbs">
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <!-- Quotation Requests breadcrumbs -->
            <li t-if="page_name == 'quotation_lists'" class="breadcrumb-item">
                <span>Quotation Requests</span>
            </li>
            <li t-if="page_name == 'create_quotation'" class="breadcrumb-item">
                <a href="/my/quotations">Quotation Requests</a>
                /
                <span>Create Request</span>
            </li>
            <li t-if="page_name == 'view_quotation'" class="breadcrumb-item">
                <a href="/my/quotations">Quotation Requests</a>
                /
                <span>View Details</span>
            </li>
            <li t-if="page_name == 'edit_quotation'" class="breadcrumb-item">
                <a href="/my/quotations">Quotation Requests</a>
                /
                <span>Edit Request</span>
            </li>
        </xpath>
    </template>
    <template id="quotation_request_list" name="Quotation Request List">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <div class="wrapper col-12 d-flex flex-wrap justify-content-between align-items-center">
                <h2 class="frontend">My Quotation Requests</h2>
                <a href="/my/quotations/new" class="btn btn-primary px-3 py-2 d-flex align-items-center gap-2 ms-auto">
                    <i class="fa fa-plus"></i> New
                </a>
            </div>

            <t t-if="not requests">
                <div class="alert alert-info" role="alert">
                    There are no quotation requests.
                </div>
            </t>
            <div class="mt-4">
                <t t-if="requests" t-call="portal.portal_table">
                    <thead>
                        <tr class="active">
                            <th>Reference</th>
                            <th>Delivery Deadline</th>
                            <th>Status</th>
                            <th class="text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="requests" t-as="request">
                            <tr>
                                <td>
                                    <a t-attf-href="/my/quotations/#{request.id}">
                                        <t t-esc="request.name"/>
                                    </a>
                                </td>
                                <td><span t-field="request.delivery_deadline"/></td>
                                <td>
                                    <span t-field="request.state" t-options='{"widget": "badge", "className": "badge-info"}'/>
                                </td>
                                <td class="text-right">
                                    <span t-field="request.amount_total" t-options='{"widget": "monetary", "display_currency": request.currency_id}'/>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </t>
            </div>
        </t>
    </template>
    
    <template id="create_quotation_request" name="Create Quotation Request">
        <t t-call="portal.portal_layout">
            <div class="container mt-4">
                <div class="row">
                    <div class="col-lg-8 offset-lg-2">
                        <form action="/my/quotations/submit" method="post" class="js_website_submit_form">
                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                            <input type="hidden" id="line_count" name="line_count" value="0"/>
                            
                            <div class="card shadow-sm">
                                <div class="card-body p-4">
                                    <h2 class="card-title mb-4">Create Quotation Request</h2>
                                    
                                    <div class="form-group mb-4">
                                        <label for="delivery_deadline" class="form-label">Delivery Deadline</label>
                                        <input type="date" class="form-control" id="delivery_deadline" name="delivery_deadline" required="required" t-att-min="min_date"/>
                                    </div>
                                    
                                    <div id="product-lines" class="mb-4">
                                    </div>
                                    
                                    <button type="button" class="btn btn-outline-primary mb-4" onclick="addProductLine()">
                                        <i class="fa fa-plus me-2"></i> Add Product
                                    </button>
                                    
                                    <div class="text-end">
                                        <button type="submit" class="btn btn-primary px-4">Submit Request</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <style>
                .card {
                    border-radius: 12px;
                    border: none;
                    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07);
                    transition: box-shadow 0.3s ease, transform 0.3s ease;
                }
                .card:hover {
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 10px 20px rgba(0, 0, 0, 0.1);
                    transform: translateY(-5px);
                }
                .form-control, .form-select, .btn {
                    border-radius: 8px;
                }
                .product-line {
                    background-color: #f8f9fa;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 15px;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
                }
                .product-line:hover {
                    background-color: #e9ecef;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                }
                .quantity-input {
                    text-align: center;
                }
                .btn-outline-danger {
                    transition: all 0.3s ease;
                }
                .btn-outline-danger:hover {
                    transform: translateY(-2px);
                }
            </style>

            <script type="text/javascript">
                function addProductLine() {
                    var productLines = document.querySelectorAll('.product-line');
                    var lineCount = productLines.length;
                    var newLine = document.createElement('div');
                    newLine.className = 'product-line';
                    newLine.innerHTML = `
                        <div class="row g-3 align-items-end">
                            <div class="col-md-5">
                                <label for="product_id_${lineCount}" class="form-label">Product</label>
                                <select name="product_id_${lineCount}" class="form-select product-select" required="required" onchange="updateUnit(this)">
                                    <option value="">Select a product</option>
                                    <t t-foreach="products" t-as="product">
                                        <option t-att-value="product.id" t-att-data-uom="product.uom_id.name"><t t-esc="product.name"/></option>
                                    </t>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="quantity_${lineCount}" class="form-label">Quantity</label>
                                <div class="input-group">
                                    <button class="btn btn-outline-secondary" type="button" onclick="decrementQuantity(this)">-</button>
                                    <input type="number" name="quantity_${lineCount}" class="form-control quantity-input" required="required" min="1" value="1"/>
                                    <button class="btn btn-outline-secondary" type="button" onclick="incrementQuantity(this)">+</button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Unit</label>
                                <div class="form-control unit-display" style="background-color: #f8f9fa;"></div>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-outline-danger w-100" onclick="removeProductLine(this)">
                                    <i class="fa fa-trash me-2"></i> Remove
                                </button>
                            </div>
                        </div>
                    `;
                    document.getElementById('product-lines').appendChild(newLine);
                    
                    // Show/hide remove buttons based on the number of product lines
                    updateRemoveButtonsVisibility();
                    
                    var lineCount = document.getElementById('line_count');
                    lineCount.value = parseInt(lineCount.value) + 1;
                }

                function removeProductLine(button) {
                    button.closest('.product-line').remove();
                    updateRemoveButtonsVisibility();
                    
                    var lineCount = document.getElementById('line_count');
                    lineCount.value = parseInt(lineCount.value) - 1;
                }

                function updateRemoveButtonsVisibility() {
                    var removeButtons = document.querySelectorAll('.product-line .btn-outline-danger');
                    var shouldShowRemoveButtons = removeButtons.length > 1;
                    removeButtons.forEach(button => {
                        button.style.display = shouldShowRemoveButtons ? 'block' : 'none';
                    });
                }

                function updateUnit(select) {
                    var selectedOption = select.options[select.selectedIndex];
                    var unitDisplay = select.closest('.row').querySelector('.unit-display');
                    unitDisplay.textContent = selectedOption.dataset.uom || '';
                }

                function incrementQuantity(button) {
                    var input = button.previousElementSibling;
                    input.value = parseInt(input.value) + 1;
                }

                function decrementQuantity(button) {
                    var input = button.nextElementSibling;
                    var value = parseInt(input.value);
                    if (value > 1) {
                        input.value = value - 1;
                    }
                }

                // Add this function to prepare the form before submission
                function prepareForm() {
                    var productLines = document.querySelectorAll('.product-line');
                    document.getElementById('line_count').value = productLines.length;
                    return true;
                }

                // Update the form to call prepareForm on submit
                document.querySelector('form.js_website_submit_form').onsubmit = prepareForm;

                // Initialize the form
                document.addEventListener('DOMContentLoaded', function() {
                    addProductLine(); // Add the first product line
                    updateRemoveButtonsVisibility();
                });
            </script>
        </t>
    </template>

    <template id="view_quotation_request" name="View Quotation Request">
        <t t-call="portal.portal_layout">
            <div class="container">
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h1>
                            Quotation Request <span t-esc="quotation_request.name"/>
                            <small class="text-muted" t-field="quotation_request.state" t-options='{"widget": "badge"}'/>
                        </h1>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <strong>Date:</strong> <span t-field="quotation_request.date_request"/>
                        <br/>
                        <strong>Delivery Deadline:</strong> <span t-field="quotation_request.delivery_deadline"/>
                    </div>
                    <div class="col-md-6 text-right">
                        <strong>Total Amount:</strong>
                        <span t-field="quotation_request.amount_total" t-options='{"widget": "monetary", "display_currency": quotation_request.currency_id}'/>
                    </div>
                </div>
                <h3 class="mt-4">Requested Products</h3>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th class="text-right">Quantity</th>
                            <th>Unit</th>
                            <th class="text-right">Unit Price</th>
                            <th class="text-right">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="quotation_request.line_ids" t-as="line">
                            <tr>
                                <td><span t-field="line.product_id.name"/></td>
                                <td class="text-right"><span t-field="line.quantity"/></td>
                                <td><span t-field="line.product_uom.name"/></td>
                                <td class="text-right"><span t-field="line.price_unit" t-options='{"widget": "monetary", "display_currency": quotation_request.currency_id}'/></td>
                                <td class="text-right"><span t-field="line.price_subtotal" t-options='{"widget": "monetary", "display_currency": quotation_request.currency_id}'/></td>
                            </tr>
                        </t>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right"><strong>Total</strong></td>
                            <td class="text-right"><strong t-field="quotation_request.amount_total" t-options='{"widget": "monetary", "display_currency": quotation_request.currency_id}'/></td>
                        </tr>
                    </tfoot>
                </table>
                <div t-if="quotation_request.state == 'quotation_sent'" class="mt-4">
                    <a t-att-href="'/my/quotations/%s/accept' % quotation_request.id" class="btn btn-primary">
                        Accept Quotation
                    </a>
                    <a t-att-href="'/my/quotations/%s/reject' % quotation_request.id" class="btn btn-danger">
                        Reject Quotation
                    </a>
                </div>
            </div>
        </t>
    </template>

    <template id="view_full_quotation" name="View Full Quotation">
        <t t-call="portal.portal_layout">
            <div class="container mt-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">Quotation - <t t-esc="quotation.name"/></h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h4>Sale Information</h4>
                                <p><strong>Date:</strong> <span t-field="quotation.date_order"/></p>
                                <p><strong>Expiration Date:</strong> <span t-field="quotation.validity_date"/></p>
                            </div>
                            <div class="col-md-6">
                                <h4>Invoicing and Shipping Address</h4>
                                <address t-field="quotation.partner_id" t-options='{"widget": "contact", "fields": ["address", "name", "phone", "email"]}'/>
                            </div>
                        </div>
                        <h4 class="mt-4">Products</h4>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Unit</th>
                                    <th>Unit Price</th>
                                    <th>Taxes</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="quotation.order_line" t-as="line">
                                    <tr>
                                        <td><span t-field="line.product_id.name"/></td>
                                        <td><span t-field="line.product_uom_qty"/></td>
                                        <td><span t-field="line.product_uom.name"/></td>
                                        <td><span t-field="line.price_unit"/></td>
                                        <td><span t-esc="', '.join(line.tax_id.mapped('name'))"/></td>
                                        <td><span t-field="line.price_subtotal"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                        <div class="row justify-content-end">
                            <div class="col-md-4">
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Untaxed Amount:</strong></td>
                                        <td class="text-right"><span t-field="quotation.amount_untaxed"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Taxes:</strong></td>
                                        <td class="text-right"><span t-field="quotation.amount_tax"/></td>
                                    </tr>
                                    <tr class="border-top">
                                        <td><strong>Total:</strong></td>
                                        <td class="text-right"><span t-field="quotation.amount_total"/></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>